# Example - Processing 20200304Krios_PnuC_3NR_Nanodisc dataset, totally 6910 images

# Step01 - Import images 

Input files: finished/*.tif

Node type: 2D micrographs movies (*.mrcs, *tiff)

# Step02 - Motion correction

## I/O

Input movies STAR file: Import/job003/movies.star

First frame for corrected sum: 1

Last frame for corrected sum: 0 

Pixel size (A): 0.83

Voltage (kV): 300

Dose per frame (e/A2): 1.089

Pre-exposure (e/A2): 0

## Motion

Bfactor: 150

Number of patches X, Y: 5 5

Use RELION's own implementation? Yes

## Running

Number of MPI procs: 100

Number of threads: 2

Submit to queue? Yes

Queue name: multinode



# Step03 - CTF estimation

## I/O

Input micrographs STAR file: MotionCorr/job004/corrected_micrographs.star

Spherical aberration (mm): 2.7

Voltage (kV): 300 # Because this dataset was collected on Titan Krios, Building 13, under low mag (13kx)

Amplitude contrast: 0.1

Magnified pixel size (Angstrom): 0.83

Amount of astigmastism (A): 100

## Searches

Use as default

## CTFFIND-4.1

Use CTFFIND-4.1? Yes


# Step04 - Particle Picking using GAutomatch

- [ ] cd to the MotionCor results folder generated by RELION (if you do MotionCor using RELION) -> cd to folder 2020... where you can find the *.mrc file

then,

[user@biowulf]$ sinteractive --gres=gpu:k80:1 --mem=20g -c14
[user@biowulf]$ module load gautomatch
[user@cn3144 ~]$ gautomatch --apixM 0.83 --diameter 160 *.mrc 

or,

## Using our own Linux GPU

module load Gautomatch/0.56

Gautomatch --apixM 0.83 --diameter 160 *.mrc

# Step05 - Subset selection, to discard unsatisfied micrographs

## Subsets

Select based on metadata values? Yes

Metadata label for subset selection: rlnCtfMaxResolution

Minimum metadata value: -9999.
Maximum metadata value: 4

## Running

Running without submitting to queue.

# Step06 - Import particle files generated by GAutomatch

Input files: *_automatch.star
Node type: 2D/3D particle coordinates (*.box, *_pick.star)

# Step07 - Subset selection 

Select ~200 images to make a subset, then extract particles from these images and do a quick Class2D. After quick Class2D, we can get templates that may used for template-based Autopick. In this way, we can get more accurate particle picking, and thus lower down the requirement for computational capability of following work, e.g. Class2D, Class 3D, which always cost several days for iterations and calcutations.   

# Step08 - Extract Particles

## Extract

Particle box size (pix): 200 #Since the PnuC trimer particle size is only ~80A, we may extract the particle using box size 100pix, and diameter background circle of 90 pix? 

Diameter background circle (pix): 180

# Step09 - 2D classfiicaiton

## CTF

Do CTF-correction? Yes
Ignore CTFs until first peak? Yes

## Optimization

Number of classes: 100

Mask diameter (A): 160  #Since the PnuC trimer particle size is only ~80A, we may use 90A for the mask diameter here? 

# Step10 - Subset selection

Select classes that interested, and save as templates.

# Step11 - Autopicking

Now, it's time to do template-based Auto-picking.

## I/O

Input micrographs for autopick: CtfFind/job005/micrographs_ctf.star

Pixel size in micrographs (A): -1

2D references: Select/job017/class_averages.star

## References

Pixel sieze in references (A): -1

## autopikcing

Picking thresold: 0.5

Minimum inter-particle distanc (A): 30

Maximum stddev noise: 1.1

Minimum avg noise: -0.5

Shrink factor: 0.5

## Running

Submit to queue? Yes

Queue name: gpu

# Step 12 Partcle extraction

## I/O

micrograph STAR file: CtfFind/job005/micrographs_ctf_new.star

Input coordinates: Import/job021/coords_suffix_automatch.star

OR re-extract refined particles? No

Manually set pixel size? No

## extract

Particle box size (pix): 320

Invert contrast? Yes

Normalize particles? Yes

Diameter background circle (pix): -1

Stddev for white dust removal: -1 

Stddev for black dust removal: -1

Rescale particles? Yes #This will help fast the 2D classification of large datasets, especially preliminary data from autopicking. 

Re-scale size (pixels): 80

## Helix

No

## Running 

Number of MPI procs: 16

Submit to queue? No

# Step13 - 2D classification  /job023

## I/O

Imput images STAR file: Extract/job022/particles.star

## CTF

Do CTF-correction? Yes

Have data been phase flipped? No

Ignore CTFs until first peak? Yes

## Optimization

Number of classes: 100

Regularisation parameter T: 2

Number of iterations: 25

Use fast subsets (for large data sets)? Yes

Mask diameter (A): 200  #Since the PnuC trimer particle size is only ~80A, we may use 90A for the mask diameter here? 

## Sampling

Perform image alignment? Yes

In-plane angular sampling? 6

Offset search range (pix): 5

Offset search step (pix): 1

## Helix

Classify 2D helical segments? No

## Compute

Use parallel disc I/O? Yes

Number of pooled particles: 3

Pre-read all particles into RAM? No

Copy particles to scratch directory: No

Combine iterations through disc? No

Use GPU accelerations? Yes 

## Running

Number of MPI procs: 18

Number of threads: 1

Submit to queue? Yes

Queue name: gpu

Queue submit command: sbatch

Walltime: 3-00:00:00

Memory Per Thread: 8g

Gres: lscratch:200, gpu:v100x:4

Addl (ex4) SBATCH Directives: -N 6 --ntasks-per-node=3

Standard submission script: /usr/local/apps/RELION/templates/common.sh

Minimum dedicated cores per node: 1

# Step14 Select /job026

Select classes from model.star: Class2D/job023/run_it025_model.star

# Step15 3D classification /job037

This class3D aimed at centering all the particles and further aid following 2D classifications. 

## I/O

Input images STAR file: Select/job026/particles.star

Reference map: ../PnuC_3NR_ModelBuilding/cryosparc_80Pix0.83A.mrc

## Reference

Ref. map is on absolute greyscale? No

Initial low-pass filter (A): 50

Symmetry: C3

## CTF

Do CTF-correction? Yes

Has reference been CTF-corrected? Yes

## Optimisation

Number of classes: 1

Regularisation parameter T: 4

Number of iterations: 20

Use fast subsets (for large datasets)? Yes

Mask individual particles with zeros? Yes

*If set to Yes, then in the individual particles, the area outside a circle with the radius of the particle will be set to zeros prior to taking the Fourier transform. This will remove noise and therefore increase sensitivity in the alignment and classification. However, it will also introduce correlations between the Fourier components that are not modelled. When set to No, then the solvent area is filled with random noise, which prevents introducing correlations.High-resolution refinements (e.g. ribosomes or other large complexes in 3D auto-refine) tend to work better when filling the solvent area with random noise (i.e. setting this option to No), refinements of smaller complexes and most classifications go better when using zeros (i.e. setting this option to Yes).*

Mask diameter (A): 200

## Compute

Use GPU acceleration? Yes



# Step14 - Select Model /Job165

## I/O

Select classes from model.star: 

## Class options

Re-center the class averages? Yes


# Step15 - Extract Particles /Job166

## I/O

micrograph STAR file: Select/job006/micrographs.star

OR re-extract refined particles? Yes

Refined particles STAR file: Select/job041/particles.star

OR: re-center refined coordinates? Yes

Recenter on - X,Y,Z (pix): 0 0 0 

## Extract

Particle box size (pix): 200

Invert contrast? Yes

Normalize particles? Yes

Diameter background circle (pix): 180

Rescale particles? No


# Step16 - Refine3D /Job049

## I/O

Input images STAR file: Extract/job042/particles.star

Reference map: Class3D/job038/run_ct6_it025_class005.mrc

## Reference

Ref. map is on absolute greyscale? No

Initial low-pass filter (A): 50

Symmetry: C3

## CTF

Do CTF-correction? Yes

Ignore CTFs until first peak? Yes

## Optimisation

Mask diameter (A): 200

Mask individual particles with zeros? Yes

Use solvent-flattened FSCs? No

## Compute

Use GPUs

## Running

Number of MPI procs: 9

Number of threads: 1

Submit to queue? Yes

Queue name: gpu

Queue submit command: sbatch

Walltime: 1-00:00:00

Memory Per Thread: 8g

Gres: lscratch:200

Addl (ex4) SBATCH Directives: -N 3 --ntaks-per-node=3


# Step17 - MaskCreate /Job056

## I/O

Input 3D map: Refine3D/job049/run_class001.mrc

## Mask

Lowpass filter map (A): 15

Initial binarisation threshold: 0.01 #Usually we start this parameter with 0.01, and then optimize around 0.01 by step of 0.002 to get best resolution. 

Extend binary map this many pixels: 20

Add a soft-edge of this many pixels: 20

## Running

using CPUs.

Number of threads: 16


# Step18 - PostProcess /Job060

## I/O

One of the 2 unfiltered half-map: Refine3D/job049/run_half1_class001_unfil.mrc

Solvent mask: MaskCreate/job059/mask.mrc

Calibrated pixel size (A): 1.06

## Sharpen

Estimate B-factor automatically? Yes

## Running

Using CPUs.

Submit to queue? No



# Step19 - CtfRefine

## I/O

Particles (from Refine3D): Refine3D/job182/run_data.star

Postprocess STAR file: PostProcess/job406/postprocess.star

## Fit

Minimum resolution for fits (A): 30

Perform CTF parameters fitting? Yes

Fit per-particles defocus? Yes

Range for defocus fit (A): 2000

Fit per-micrograph astigmatism? No

Fit per-particle astigmatism? No

Fit per-micrograph phase-shift? No

Perform beamtilt estimation? Yes

## Running

Number of MPI procs: 65

Number of threads: 4

Submit to queue? Yes

Queue name: multinode

Queue submit command: sbatch

Walltime: 1-00:00:00

Memory Per Thread: 8g

Gres: lscratch:200




# Step20 - Bayesian Polishing - Running in training mode

## I/O

Micrographs (from MotionCorr): MotionCorr/job004/corrected_micrographs.star

Particles (from Refine3D or CtfRefine): CtfRefine/job079/particles_ctf_refine.star

Postprocess STAR file: PostProcess/job060/postprocess.star

First movie frame: 1

Last movie frame: -1

## Train

Train optimal parameters? Yes

Fraction of Fourier pixels for testing: 0.5

Use this many particles: 5000

## Polish

Perform particle polishing? No

## Running 

Number of MPI procs: 1 #Here training mode, you can only use 1 MPI, but may use multi threads to speed up

Number of threads: 16

Submit to queue? No




# Step21 - Bayesian Polishing - Running in polishing mode


## I/O

Micrographs (from MotionCorr): MotionCorr/job004/corrected_micrographs.star

Particles (from Refine3D or CtfRefine): CtfRefine/job079/particles_ctf_refine.star

Postprocess STAR file: PostProcess/job060/postprocess.star

First movie frame: 1

Last movie frame: -1

## Train

Train optimal parameters? No

## Polish

Perform particle polishing? Yes

Optimised parameter file: Polish/job084/opt_params.txt

OR use your own parameters? No

Minimum resolution for B-factor fit (A): 20

Maximum resolution for B-factor fit (A): -1

## Running 

Number of MPI procs: 1

Number of threads: 16

Submit to queue? Yes

Queue name: multinode

Queue submit command: sbatch

Walltime: 1-00:00:00

Memory Per Thread: 8g

Gres: lscratch:200



# Step22 - Refine3D /Job167

## I/O

Input images STAR file: Polish/job106/shiny.star

Reference map: Class3D/job021/run_it025_class004.mrc

Reference mask (optional): MaskCreate/job027/mask.mrc

## Reference

Ref. map is on absolute greyscale? No

Initial low-pass filter (A): 50

Symmetry: C3

## CTF

Do CTF-correction? Yes

Ignore CTFs until first peak? Yes

## Optimisation

Mask diameter (A): 106

Mask individual particles with zeros? Yes

Use solvent-flattened FSCs? Yes

## Compute

Use GPUs



# Step23 - PostProcess /Job

## I/O

One of the 2 unfiltered half-map: Refine3D/job167/run_ct15_half1_class001_unfil.mrc

Solvent mask: MaskCreate/job180/mask.mrc

Calibrated pixel size (A): 1.06

## Sharpen

Estimate B-factor automatically? Yes

## Running

Using CPUs.



















