*This doccument shows step by step how to do the bfactor plot, from which one can estimate how many particles or how many raw image still needed if we want to push the resolution to the number we want. 

# The main algrithm 
## This script need your Refine3D job and postprocess job, and extract certain amount of particles and redo Refine3D and postprocess by 12 iterations, each cycle has different number (more particles next cycle) of particles and finally give a Particle number ~ Resolution plot. 

# Step 01 - Copy the bfactor_plot.py script
## Copy the bfactor_plot.py script to the project folder where you start the RELION GUI. 
For example, when I am processing the following data, just copy bfactor_plot.py here into this folder
- [ ] /data/dout2/20200107Krios_PnuC_0NR_C8 

# Step 02 - Edit bfactor_plot.py to reflect your experiment
## Open the bfactor_plot.py script by any text editor you like, and change parameters to reflect your experiment:
*For example, here I use nano
- [ ] nano bfactor_plot.py 

``````
#############################################################################
    # Change the parameters below to reflect your experiment   #
#############################################################################

    # job prefix
    prefix = 'BFACTOR_PLOT_'

    # Refine3D job with all particles
    input_refine3d_job = 'Refine3D/job026/'
    # PostProcess job for resolution assessment
    input_postprocess_job = 'PostProcess/job028/'
    # Minimum number of particles
    minimum_nr_particles = 100
    # Maximum number of particles
    maximum_nr_particles = 9999999

    #### relion_refine paremeters 
    # Initial low-pass filter for the refinements
    refine_ini_lowpass = 50
    # Read all particles in one batch into memory?
    refine_preread_images = False
    # Or copy particles to scratch disk?
    refine_scratch_disk = ''
    # Number of pooled particles?
    refine_nr_pool = 3
    # Use GPU-acceleration?
    refine_do_gpu = True
    # Which GPU to use (different from GPU used for pre-processing?)
    refine_gpu = ''
    # How many MPI processes to use
    refine_mpi = 9
    # How many threads to use
    refine_threads = 1
    # Skip padding?
    refine_skip_padding = False
    # Submit jobs to the cluster?
    refine_submit_to_queue = True

    ### Cluster submission settings
    # Name of the queue to which to submit the job
    queue_name = 'gpu'
    # Name of the command used to submit scripts to the queue
    queue_submit_command = 'sbatch'
    # The template for your standard queue job submission script
    queue_submission_template = '//usr/local/apps/RELION/templates/common.sh'
    # Minimum number of dedicated cores that need to be requested on each node
    queue_minimum_dedicated = 1
    
    #######################################################################
    ############ typically no need to change anything below this line
    ####################################################################### 
``````
## It should be noted that, here we submit jobs to Biowulf using "sbatch" command and want to use GPU (queue_name='gpu'), refine_mpi=9 means you want to use 9 MPIs. Moreover, the exact GPU node used (e.g. K80, P100) is usually the same as the Refine3D job you defined. 

# Step 03 - Run the script
- [ ] ./bfactor_plot.py
*Note: If you are permission denied to run, this means you do not asign execute rights to this script, just change rights:
- [ ] chmod 777 ./bfactor_plot.py
*When started, this script will run for several hours, and also in the RELION GUI, you will see new jobs generated by this script.
## How to submit script run to Biowulf:
*However, if you want to sumbit the script as a sbatch job, so that you can close the sinteractive node, just do:
- [ ] sbatch --cpus-per-task=16 --time=1-0 ./bfactor_plot.py

# Step 04 - The results
## After hours of running, you will find a "BFACTOR_PLOT_rosenthal-henderson-plot.pdf" file in the RELION project folder, this is the bfactor plot we want.
- [ ] "BFACTOR_PLOT_rosenthal-henderson-plot.pdf"
