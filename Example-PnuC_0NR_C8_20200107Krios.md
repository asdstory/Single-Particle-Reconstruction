# Example - Processing PnuC_0NR_C8_20200106, totally 4525 images

# Step01 - Import images 

Input files: 2020-01-06-PnuC_0NR_C8-leginon-counting-finished-frames/*.tif

Node type: 2D micrographs movies (*.mrcs, *tiff)

# Step02 - Motion correction

## I/O

Input movies STAR file: Import/job003/movies.star

First frame for corrected sum: 1

Last frame for corrected sum: 0 

Pixel size (A): 1.06

Voltage (kV): 300

Dose per frame (e/A2): 1.42

Pre-exposure (e/A2): 0

## Motion

Bfactor: 150

Number of patches X, Y: 5 5

Use RELION's own implementation? Yes

## Running

Number of MPI procs: 100

Number of threads: 2

Submit to queue? Yes

Queue name: multinode



# Step03 - CTF estimation

## I/O

Spherical aberration (mm): 2.7
Voltage (kV): 300 # Because this dataset was collected on Titan Krios, Building 13, under low mag (13kx)
Amplitude contrast: 0.1
Magnified pixel size (Angstrom): 1.06
Amount of astigmastism (A): 100

#Searches

Use as default

#CTFFIND-4.1

Use CTFFIND-4.1? Yes

# Step04 - Particle Picking using GAutomatch

- [ ] cd to the MotionCor results folder generated by RELION (if you do MotionCor using RELION) -> cd to folder 2020... where you can find the *.mrc file

then,

[user@biowulf]$ sinteractive --gres=gpu:k80:1 --mem=20g -c14
[user@biowulf]$ module load gautomatch
[user@cn3144 ~]$ gautomatch --apixM 1.06 --diameter 160 *.mrc 

or,

## Using our own Linux GPU

module load Gautomatch/0.56

Gautomatch --apixM 1.06 --diameter 160 *.mrc

# Step05 - Subset selection, to discard unsatisfied micrographs

## Subsets

Select based on metadata values? Yes

Metadata label for subset selection: rlnCtfMaxResolution

Minimum metadata value: -9999.
Maximum metadata value: 5

## Running

Running without submitting to queue.

# Step06 - Import particle files generated by GAutomatch

Input files: *_automatch.star
Node type: 2D/3D particle coordinates (*.box, *_pick.star)

# Step07 - Subset selection 

Select ~200 images to make a subset, then extract particles from these images and do a quick Class2D. After quick Class2D, we can get templates that may used for template-based Autopick. In this way, we can get more accurate particle picking, and thus lower down the requirement for computational capability of following work, e.g. Class2D, Class 3D, which always cost several days for iterations and calcutations.   

# Step08 - Extract Particles

#Extract

Particle box size (pix): 200

Diameter background circle (pix): 180

# Step09 - 2D classfiicaiton

# CTF

Do CTF-correction? Yes
Ignore CTFs until first peak? Yes

# Optimization

Number of classes: 100

Mask diameter (A): 160

# Step10 - Subset selection

Select classes that interested, and save as templates.

# Step11 - Autopicking

Now, it's time to do template-based Auto-picking.

## I/O

Input micrographs for autopick: CtfFind/job005/micrographs_ctf.star

Pixel size in micrographs (A): -1

2D references: Select/job017/class_averages.star

## References

Pixel sieze in references (A): -1

## autopikcing

Picking thresold: 0.8

Minimum inter-particle distanc (A): 100

Maximum stddev noise: 1.1

Minimum avg noise: -0.5

Shrink factor: 1

## Running

Submit to queue? Yes

Queue name: gpu

# Step12 3D initial model 

## I/O

Input images STAR file: Select/job030/particles.star

Reference map: InitialModel/job031/run_it300_class001.mrc

## CTF

Do CTF-correction? Yes

Ingore CTFs until first peak? Yes

## Optimisation

Number of classes: 6

Mask diameter (A): 200

Symmetry: C1

## Compute

Use GPU acceleration? Yes

# Step13 - Class3D /Job163

## I/O

Input images STAR file: Select/job030/particles.star

Reference map: InitialModel/job031/run_it300_class001.mrc

## Reference

Ref. map is on absolute greyscale? No

Initial low-pass filter (A): 50

Symmetry: C3

## CTF

Do CTF-correction? Yes

Has reference been CTF-corrected? Yes

## Optimisation

Number of classes: 4

Regularisation parameter T: 4

Number of iterations: 50

Mask diameter (A): 150

## Compute

Use GPU acceleration? Yes


# Step14 - Select Model /Job165

## I/O

Select classes from model.star: 

## Class options

Re-center the class averages? Yes


# Step15 - Extract Particles /Job166

## I/O

micrograph STAR file: Select/job006/micrographs.star

OR re-extract refined particles? Yes

Refined particles STAR file: Select/job041/particles.star

OR: re-center refined coordinates? Yes

Recenter on - X,Y,Z (pix): 0 0 0 

## Extract

Particle box size (pix): 200

Invert contrast? Yes

Normalize particles? Yes

Diameter background circle (pix): 180

Rescale particles? No


# Step16 - Refine3D /Job167

## I/O

Input images STAR file: Extract/job166/particles.star

Reference map: Class3D/job163/run_ct25_it050_class001_box256.mrc

## Reference

Ref. map is on absolute greyscale? No

Initial low-pass filter (A): 50

Symmetry: C3

## CTF

Do CTF-correction? Yes

## Optimisation

Mask diameter (A): 150

Mask individual particles with zeros? Yes

Use solvent-flattened FSCs? No

## Compute

Use GPUs


# Step17 - MaskCreate /Job056

## I/O

Input 3D map: Refine3D/job167/run_ct15_class001.mrc

## Mask

Lowpass filter map (A): 15

Initial binarisation threshold: 0.02

Extend binary map this many pixels: 20

Add a soft-edge of this many pixels: 20

## Running

using CPUs.

Number of threads: 9. #Here we can also use 16

# Step18 - PostProcess /Job181

## I/O

One of the 2 unfiltered half-map: Refine3D/job167/run_ct15_half1_class001_unfil.mrc

Solvent mask: MaskCreate/job180/mask.mrc

Calibrated pixel size (A): 1.06

## Sharpen

Estimate B-factor automatically? Yes

## Running

Using CPUs.


# Step19 - CtfRefine

## I/O

Particles (from Refine3D): Refine3D/job182/run_data.star

Postprocess STAR file: PostProcess/job406/postprocess.star

## Fit

Minimum resolution for fits (A): 30

Perform CTF parameters fitting? Yes

Fit per-particles defocus? Yes

Range for defocus fit (A): 2000

Fit per-micrograph astigmatism? No

Fit per-particle astigmatism? No

Fit per-micrograph phase-shift? No

Perform beamtilt estimation? Yes

## Running

Number of MPI procs: 65

Number of threads: 4

Submit to queue? Yes

Queue name: multinode

Queue submit command: sbatch

Walltime: 1-00:00:00

Memory Per Thread: 8g

Gres: lscratch:200




# Step20 - Bayesian Polishing - Running in training mode

## I/O

Micrographs (from MotionCorr): MotionCorr/job485/corrected_micrographs.star

Particles (from Refine3D or CtfRefine): CtfRefine/job520/particles_ctf_refine.star

Postprocess STAR file: PostProcess/job519/postprocess.star

First movie frame: 1

Last movie frame: -1

## Train

Train optimal parameters? No

## Polish

Perform particle polishing? Yes

Optimised parameter file: Polish/job522/opt_params.txt

OR use your own parameters? No

Minimum resolution for B-factor fit (A): 20

Maximum resolution for B-factor fit (A): -1

## Running 

Number of MPI procs: 1

Number of threads: 16

Submit to queue? Yes

Queue name: multinode

Queue submit command: sbatch

Walltime: 1-00:00:00

Memory Per Thread: 8g

Gres: lscratch:200




# Step21 - Bayesian Polishing - Running in polishing mode

## I/O

Micrographs (from MotionCorr): MotionCorr/job004/corrected_micrographs.star

Particles (from Refine3D or CtfRefine): Refine3D/job065/run_data.star

Postprocess STAR file: PostProcess/job067/postprocess.star

First movie frame: 1

Last movie frame: -1

## Train

Train optimal parameters? Yes

Fraction of Fourier pixels for testing: 0.5

Use this many particles: 5000

## Polish

Perform particle polishing? No

## Running 

Number of MPI procs: 1

Number of threads: 1

Submit to queue? No





















