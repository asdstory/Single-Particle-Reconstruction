# Mask Selection and Generation

It's important to be careful when selecting the masks to be used in the local refinement. The closer the subvolume is to being rigid, i.e. it doesn't bend or deform, the more effective the local refinement will be. You can use the results of the Local Resolution job to help you identify these regions. You want to create two masks - one including only the region you are interested in, and another that includes every other region of the structure except the region of interest. To generate the necessary masks, you can use UCSF Chimera and follow the instructions below.

To start making the mask, open up your volume in Chimera. First, you want to set the viewing level at a value that minimizes the amount of "dust" visible outside of the structure, while also making sure all of the structure is also visible. This is typically a little higher than the optimal viewing level. For our structure, this was around 0.18. Now, we will binarize the mask using thresholds. Using Chimera's command line (Favorites > Command Line), type the following two commands: vop threshold #0 minimum 0.18 set 0 and vop threshold #1 maximum 0.17 set 1. Change #0 for the model ID in your session, and 0.18 with your optimal viewing level. These two commands will map every voxel with a density below 0.18 to 0, and every voxel above 0.17 to 1. Make sure you run the second command on the output of the first one. (Note: we've occasinally encountered a bug where the maximum gets set at some value lower than 1. This is OK, you should make sure you use the correct threshold in later steps when using Volume Tools in cryoSPARC. You can also use Chimera's vop multiply command to get the values to 1.)

Navigate to Tools > Volume Tools > Volume Eraser. You will now see a transparent sphere floating next to your structure. You can use the middle mouse button to move the sphere, and press Erase to delete chunks of the binarized volume until you are left with the desired region. Note that Chimera will subtract from the currently active volume only, and it will generate a new subtracted volume instead of overwriting the original.

## Volume Eraser in Chimera

Once you've created the first mask, save it as a new .mrc file. To generate the negative version of it, we can simply run vop subtract #2 #3, where #2 is the binarized overall structure, and #3 is the mask you've created. The result of the subtraction will be the negative of the mask you created. At this point, you should have two contiguous volumes generated from the original map. The masks we generated for the head look like this:

## Raw Masks

Now, to make sure that you haven't excluded any important regions in your masks, and to avoid Fourier-space artifacts due to the sharp edges, we will dilate and add soft edges to the masks. You can use the Import 3D Volumes tool to import the newly-made masks into cryoSPARC - make sure you set the map type to mask in the parameters before you run the job.

You can now take the results from the import jobs, create two new Volume Tools jobs and connect them into the mask input slot of each. You can use the following parameters. This job will also fill the holes inside your structure, and give you a solid map. Make sure to specify the output type as mask.

## Vol Tools Params
Changing the Dilation Radius and Cosine Padding Width may affect the results of the Local Refinement job since this mask is used to select the region of interest. We used a dilation radius of 5 and no padding for this dataset. Our masks looked like this:

## Processed masks
The initial mask provided is used to select the region of the molecule that will be refined. However, the masking during each iteration refinement is done using a dynamic mask that is generated by the algorithm based on the constructed volume.

## Fulcrum Selection
cryoSPARC's local refinement allows you to specify the "fulcrum" around which the subvolume of interest may rotate. Using the location of the fulcrum, cryoSPARC will re-calculate the local angular search grid to make it more accurate. This is equivalent to re-centering particles to the position of the fulcrum in each particle image, and often makes a substantial difference to the final result of local refinement.

You can leave the fulcrum parameters blank in the Local Refinement if you are unsure where it should be.

To find the coordinates of the fulcrum, you can use the Volume Tracer tool in Chimera. We will place our fulcrum at the bottom of the head region, around the marker you see pictured in the image below. Go to Tools > Volume Data > Volume Tracer to open up the Volume Tracer dialog. From mouse, select Place markers on high density. Navigate to the part of the structure you want to place the fulcrum on, and use the middle mouse to drop a spherical marker.

## Marker
To get its coordinates, type getcrd sel into the command line (assuming you still have the marker selected). Note that these coordinates are in Angstroms, while the local refinement job expects a value in voxels. Simply divide the values by the pixel size, which is 1.4 for this dataset, to get the correct fulcrum. The fulcrum we found was (196, 197, 211).

# Particle Subtraction
The Particle Subtraction job takes in the overall structure that you got from the NU-Refine or Homogenous Refine jobs, and subtracts a projection of a masked region of it from the original particles to create a stack of subtracted particles. These particles can be used in local refinement to get better alignments - now that the unwanted signal from a chunk of the volume is subtracted, the alignments will be based only on the region of focus.

For the snRNP, we first tried out focusing on the head region, since it seemed to be the most dynamic. So, we used the mask that included everything but the head as the input for particle subtraction. Make sure you also input the particles outputted by a previous refinement job, since the alignment3D fields are required for Particle Subtraction.

To set the Inner and Outer Radius of Reference Window parameters, you must refer to the refinement job used to generate the reference structure you are using. Since the windowing affects the scale of the particles, it is important that these values are identical to the values used in the job that generated the reference volume. The outputs of this job won't be windowed, but in order for the subtraction scale to be correct you need the windowing radii.

The Particle Subtraction job uses the two halfmaps generated in the refinement job, so it will hold up the Gold-Standard FSC assumptions. The two half-maps are also filtered before subtraction, preventing any high-resolution noise from being injected into the structure.

# Local Refinement
Now, with this newly-subtracted stack of particles, we can locally refine the head region of the snRNP to get a better map.

The first parameters we set are the fulcrum parameters. Since connection between the head region and the rest of the body is not at the origin, we will have to account for this in the search for rotations. As found earlier, (196, 197, 211) will work here. There is no need to attempt to optimize the fulcrum location.

## Search Ranges
The next few parameters help decide the search range and precision for the alignment step. Trying various results here can have significant impact on the results. Based on the range of motion seen in the particle from the heterogenous refinement earlier, we can start with an initial estimate of 3 pixels of shift and 25 degrees of rotation. We also used as 0.2 degrees for the final alignment resolution - the search will not attempt to align the particles beyond this value.

There are a few indicators that can diagnose a problem with your search ranges - one of them being the histograms displaying the pose & shift changes. In our case, the smooth distribution of poses suggests that we've correctly chosen the range of rotations.

## Pose Change Histogram
On the other hand, there seems to be a peak at the edge of the shift extent. One possible explanation for this is a narrow search extent for shifts, though it may also be caused by an inaccurate fulcrum choice. The two parameters are coupled.

## Shift Change Histogram
### Other parameters
NU-Refinement: enabling non-uniform refinement for this dataset improved our results, in some cases substantially.
Override number of iterations: if you want to force a certain number of iterations, enable this parameter.
Sharpening
It is possible that the outputs of the local refinement will be undersharpened, so a sharpening job may improve the interpretability of the results. Using the new Sharpening Tools job with all of the default parameters and a B-Factor of -150, we can obtain a map that improves the visibility of the high-resolution features.

### Results
Applying the above process to the head region (right) brought us down to a resolution of 3.88Å, which was a 0.3Å improvement on the original publication. The foot region (left) performed even better, reaching a resolution of 3.44Å compared to the published resolution of 3.7Å.

Foot Result Head Result
Comparing the sharpened output volumes from the head to the published volumes, cryoSPARC's improvement of the final maps is clear.

Comparing published map to cryoSPARCComparing published map to cryoSPARC

# Mask Creation: 

Once you have identified a region of interest that you would like to refine further, you can use a few methods to extract a mask from it. The recommended tool to use here is Chimera, and you can take any of the following three tools. Note that your mask should be the saved on an identical grid as the original structure, and should have an origin of [0,0,0]. To force Chimera to save your map on the same grid as your original map, you can run the vop resample #1 onGrid #2 command where #1 is your off-grid mask and #2 is your original structure.


## Volume Eraser: 
The Chimera Volume Eraser tool is fairly self-explanatory. You can use a variable-sized sphere to delete chunks off the original structure to leave you with the region of interest


## Segment Map: 
You can use the built-in segmentation tool in Chimera to algorithmically segment your volume, and group the subvolumes together until you have your region of interest in one segment. Then, you can save this segment as a .mrc file.


## Fit in Map: 
If you already have an atomic model of the region of the structure you want to refine, you can open it in the same session as your original structure and use the Fit in Map tool to align it. Then, you can use the molmap command to create a new volume from the atomic model that can serve as a mask.

# Mask Processing: 

Use the Volume Tools job to dilate your masks, add soft padding, and fill holes. This mask will be used to select a region of the structure to refine, but a dynamically generated mask will be used at each iteration of alignment.

# Fulcrum: 

Instead of doing a naive search that extends uniformly in each direction from the original pose, cryoSPARC gives the option to account for rotations around the connection point between the subvolume and the original structure. Note that the fulcrum is indexed from the corner of the structure, not the center ([0,0,0] will correspond a corner of the structure, not the center). Leaving the fulcrum option unset in the job builder will default to using the center of the structure as the rotation point. If it is hard to choose an exact fulcrum, or you are unsure about your selection, it may improve results to increase the "Local shift search extent" parameter.

# Branch and Bound: 

cryoSPARC's GPU-accelerated Branch and Bound algorithm accurately searches over a range of poses and shifts to find the best alignment of each image. The poses are forced to remain close to the original pose - how far it can stray away from the original pose is governed by the search extent parameters. The rotation extent (in radians) limits the magnitude of the angle of each rotation, the algorithm will search over rotations in all directions within the extent. The shift extent in pixels limits the diameter of the circle over which the shift is searched.

# Non-Uniform Refinement BETA: 

The Non-Uniform Refinement job, which is particularly useful for particles that have non-uniform structural characteristics, like membrane proteins or other macromolecules with unresolved peripheral structure, is also available as a feature in local refinement. This can often improve the quality of the map in your region of interest.

# FSC Calculation: 

The FSC plots will show the Global FSC, spherical masked FSC as well as the locally masked FSC. It it typical for the local FSCs (tight & loose mask) to be significantly better than the global values, since they are calculated using a dynamic mask around the computed structure.

# Gold Standard: 

The local refinement job follows the Gold-Standard FSC assumptions the same way a typical refinement job does. Particles are split into two halves using the splits from the previous refinement jobs, and the alignments are computed on independent halfmaps.

# New output plots!: 

The local refinement job will output heatmaps showing the magnitude of the change in poses and shifts for each initial position. Also, you will be able to see the distribution of the magnitude of changes for poses and shifts in the form of histograms.

# Adopted from: 
- https://cryosparc.com/blog/local-refinement
